<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingredient Translator</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a12;
      --bg-card: rgba(255,255,255,0.03);
      --bg-card-hover: rgba(255,255,255,0.06);
      --border-subtle: rgba(255,255,255,0.08);
      --text-primary: #f0f0f5;
      --text-secondary: rgba(255,255,255,0.6);
      --text-muted: rgba(255,255,255,0.4);
      --accent-green: #10b981;
      --accent-purple: #8b5cf6;
      --accent-red: #ef4444;
      --accent-orange: #f59e0b;
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: var(--bg-primary);
      background-image: radial-gradient(ellipse at 20% 0%, rgba(139,92,246,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(16,185,129,0.06) 0%, transparent 50%);
      font-family: 'DM Sans', system-ui, sans-serif;
      color: var(--text-primary);
      padding: 16px;
      padding-bottom: 100px;
      font-size: 18px;
      line-height: 1.6;
    }
    .container { max-width: 540px; margin: 0 auto; }
    .header { text-align: center; padding: 28px 0 32px; }
    .logo { font-size: 56px; margin-bottom: 14px; filter: drop-shadow(0 0 25px rgba(139,92,246,0.4)); }
    h1 { font-size: 32px; font-weight: 700; margin-bottom: 10px; background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 50%, #e9d5ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { color: var(--text-secondary); font-size: 17px; margin-bottom: 12px; }
    .stats-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(139,92,246,0.15); padding: 8px 16px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; color: #c4b5fd; border: 1px solid rgba(139,92,246,0.2); }
    .card { background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 16px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 6px; border-radius: var(--radius-md); }
    .tab { flex: 1; padding: 14px 16px; border: none; background: transparent; color: var(--text-secondary); font-size: 16px; font-weight: 600; font-family: inherit; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s; }
    .tab.active { background: rgba(139,92,246,0.2); color: #e9d5ff; }
    .tab:hover:not(.active) { background: rgba(255,255,255,0.05); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .btn-search { width: 100%; background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%); border: none; border-radius: var(--radius-md); padding: 18px 24px; color: white; font-size: 20px; font-weight: 700; cursor: pointer; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s, box-shadow 0.2s; }
    .btn-search:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(16,185,129,0.3); }
    .or-divider { text-align: center; color: var(--text-muted); font-size: 15px; margin: 16px 0; display: flex; align-items: center; gap: 16px; }
    .or-divider::before, .or-divider::after { content: ''; flex: 1; height: 1px; background: var(--border-subtle); }
    .examples-label { font-size: 15px; color: var(--text-secondary); margin-bottom: 10px; }
    .examples { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 18px; }
    .btn-example { background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); padding: 12px 18px; font-size: 16px; border-radius: var(--radius-sm); color: white; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .btn-example:hover { background: rgba(255,255,255,0.1); }
    textarea { width: 100%; background: rgba(0,0,0,0.4); border: 2px solid var(--border-subtle); border-radius: var(--radius-md); padding: 20px; color: var(--text-primary); font-size: 18px; font-family: inherit; resize: none; min-height: 140px; line-height: 1.6; }
    textarea:focus { outline: none; border-color: rgba(139,92,246,0.5); box-shadow: 0 0 30px rgba(139,92,246,0.15); }
    textarea::placeholder { color: var(--text-muted); }
    .btn { background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%); border: none; border-radius: var(--radius-md); padding: 18px 28px; color: white; font-size: 18px; font-weight: 700; cursor: pointer; width: 100%; font-family: inherit; margin-top: 16px; transition: transform 0.2s, box-shadow 0.2s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(139,92,246,0.35); }
    #selectedProduct { display: none; margin-bottom: 16px; }
    #selectedProduct.active { display: block; }
    .selected-product-card { background: linear-gradient(135deg, rgba(16,185,129,0.12) 0%, rgba(16,185,129,0.04) 100%); border: 1px solid rgba(16,185,129,0.25); border-radius: var(--radius-lg); padding: 18px; display: flex; align-items: center; gap: 16px; }
    .selected-product-image { width: 80px; height: 80px; object-fit: contain; background: white; border-radius: var(--radius-md); flex-shrink: 0; }
    .selected-product-placeholder { width: 80px; height: 80px; background: rgba(255,255,255,0.08); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 32px; flex-shrink: 0; }
    .selected-product-info { flex: 1; min-width: 0; }
    .selected-product-name { font-weight: 700; font-size: 18px; margin-bottom: 4px; color: #86efac; }
    .selected-product-brand { font-size: 15px; color: var(--text-secondary); }
    .selected-product-serving { font-size: 14px; color: var(--text-muted); margin-top: 4px; }
    .selected-product-clear { background: rgba(255,255,255,0.1); border: none; color: var(--text-secondary); width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; flex-shrink: 0; }
    .btn-favorite { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #fca5a5; width: 36px; height: 36px; border-radius: 50%; font-size: 16px; cursor: pointer; flex-shrink: 0; margin-right: 8px; }
    .btn-favorite.favorited { background: rgba(239,68,68,0.3); color: #ef4444; }
    .health-gauge-container { background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 100%); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 16px; text-align: center; }
    .health-gauge-title { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; }
    .health-gauge { position: relative; width: 200px; height: 110px; margin: 0 auto 16px; }
    .gauge-bg { width: 200px; height: 100px; border-radius: 100px 100px 0 0; background: linear-gradient(90deg, #22c55e 0%, #84cc16 25%, #eab308 50%, #f97316 75%, #ef4444 100%); position: relative; overflow: hidden; }
    .gauge-bg::after { content: ''; position: absolute; bottom: 0; left: 10px; right: 10px; height: 60px; background: var(--bg-primary); border-radius: 80px 80px 0 0; }
    .gauge-needle { position: absolute; bottom: 0; left: 50%; width: 4px; height: 70px; background: white; transform-origin: bottom center; transform: translateX(-50%) rotate(var(--rotation, -90deg)); border-radius: 2px; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    .gauge-needle::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 16px; height: 16px; background: white; border-radius: 50%; }
    .gauge-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-muted); padding: 0 10px; }
    .health-score { font-size: 48px; font-weight: 800; margin-bottom: 8px; }
    .health-score.good { color: #22c55e; }
    .health-score.okay { color: #eab308; }
    .health-score.poor { color: #f97316; }
    .health-score.bad { color: #ef4444; }
    .health-label { font-size: 18px; font-weight: 600; margin-bottom: 12px; }
    .health-summary { font-size: 15px; color: var(--text-secondary); line-height: 1.5; }
    .risk-flags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; justify-content: center; }
    .risk-flag { padding: 8px 14px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .risk-flag.danger { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
    .risk-flag.warning { background: rgba(245,158,11,0.15); color: #fcd34d; border: 1px solid rgba(245,158,11,0.3); }
    .risk-flag.caution { background: rgba(59,130,246,0.15); color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); }
    #results { display: none; }
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: #e9d5ff; display: flex; align-items: center; gap: 10px; }
    .breakdown-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .breakdown-title { font-size: 18px; font-weight: 700; }
    .breakdown-count { font-size: 15px; color: var(--text-muted); }
    .breakdown-note { font-size: 15px; color: var(--text-muted); margin-bottom: 20px; }
    .ingredient-card { background: var(--bg-card); border-radius: var(--radius-md); padding: 20px; margin-bottom: 12px; border-left: 5px solid; cursor: pointer; transition: all 0.2s ease; }
    .ingredient-card:hover { background: var(--bg-card-hover); }
    .ingredient-card.expanded { background: rgba(255,255,255,0.05); }
    .ingredient-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 12px; }
    .ingredient-name { font-weight: 700; font-size: 19px; text-transform: capitalize; line-height: 1.4; }
    .category-badge { display: inline-flex; align-items: center; gap: 6px; padding: 7px 14px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0; }
    .ingredient-explanation { font-size: 17px; color: var(--text-secondary); line-height: 1.6; margin: 0; }
    .tap-hint { font-size: 14px; color: var(--text-muted); margin-top: 10px; }
    .expanded-info { display: none; margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--border-subtle); }
    .ingredient-card.expanded .expanded-info { display: block; }
    .ingredient-card.expanded .tap-hint { display: none; }
    .info-section { margin-bottom: 16px; }
    .info-section:last-child { margin-bottom: 0; }
    .info-label { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; }
    .info-content { font-size: 16px; color: var(--text-secondary); line-height: 1.5; }
    .info-tag { display: inline-block; background: rgba(255,255,255,0.08); padding: 6px 12px; border-radius: 8px; font-size: 14px; margin-right: 8px; margin-bottom: 8px; }
    .info-tag.warning { background: rgba(239,68,68,0.2); color: #fca5a5; }
    .info-tag.good { background: rgba(34,197,94,0.2); color: #86efac; }
    .info-tag.neutral { background: rgba(255,255,255,0.1); color: var(--text-secondary); }
    .alternatives-section { background: linear-gradient(135deg, rgba(34,197,94,0.1) 0%, rgba(34,197,94,0.03) 100%); border: 1px solid rgba(34,197,94,0.2); border-radius: var(--radius-lg); padding: 20px; margin-top: 16px; }
    .alternatives-title { font-size: 17px; font-weight: 700; color: #86efac; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .alternative-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .alternative-item:last-child { border-bottom: none; }
    .alternative-icon { font-size: 20px; }
    .alternative-content { flex: 1; }
    .alternative-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .alternative-desc { font-size: 14px; color: var(--text-secondary); }
    .favorites-empty { text-align: center; padding: 48px 24px; color: var(--text-muted); }
    .favorites-empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .favorites-empty-text { font-size: 17px; margin-bottom: 8px; }
    .favorite-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 14px; cursor: pointer; transition: all 0.2s; }
    .favorite-card:hover { background: var(--bg-card-hover); }
    .favorite-image { width: 60px; height: 60px; object-fit: contain; background: white; border-radius: var(--radius-sm); flex-shrink: 0; }
    .favorite-image-placeholder { width: 60px; height: 60px; background: rgba(255,255,255,0.08); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
    .favorite-info { flex: 1; min-width: 0; }
    .favorite-name { font-weight: 600; font-size: 16px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .favorite-brand { font-size: 14px; color: var(--text-muted); }
    .favorite-score { font-size: 20px; font-weight: 800; padding: 6px 12px; border-radius: var(--radius-sm); }
    .favorite-remove { background: none; border: none; color: var(--text-muted); font-size: 18px; cursor: pointer; padding: 8px; }
    #scannerModal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); z-index: 1000; flex-direction: column; }
    #scannerModal.active { display: flex; }
    .scanner-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-subtle); }
    .scanner-title { font-size: 20px; font-weight: 700; }
    .btn-close { background: rgba(255,255,255,0.1); border: none; color: white; width: 44px; height: 44px; border-radius: 50%; font-size: 22px; cursor: pointer; }
    #scannerContainer { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .scanner-overlay { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; height: 150px; border: 3px solid var(--accent-green); border-radius: var(--radius-md); box-shadow: 0 0 0 9999px rgba(0,0,0,0.6); }
    .scanner-hint { display: none; position: absolute; bottom: 100px; left: 0; right: 0; text-align: center; color: white; font-size: 16px; }
    .scanner-status { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; }
    .search-ui { width: 100%; max-width: 400px; padding: 24px; text-align: center; }
    .search-ui-icon { font-size: 52px; margin-bottom: 16px; }
    .search-ui-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; color: var(--text-secondary); }
    .search-input { width: 100%; padding: 18px 20px; border-radius: var(--radius-md); border: 2px solid var(--accent-green); font-size: 20px; text-align: center; background: rgba(0,0,0,0.4); color: white; font-family: inherit; margin-bottom: 14px; }
    .search-input:focus { outline: none; box-shadow: 0 0 20px rgba(16,185,129,0.3); }
    .search-input::placeholder { color: var(--text-muted); }
    .search-btn { width: 100%; padding: 16px; border-radius: var(--radius-md); border: none; background: var(--accent-green); color: white; font-weight: 700; font-size: 18px; cursor: pointer; font-family: inherit; }
    .search-divider { margin: 24px 0; color: var(--text-muted); font-size: 14px; display: flex; align-items: center; gap: 12px; }
    .search-divider::before, .search-divider::after { content: ''; flex: 1; height: 1px; background: var(--border-subtle); }
    .barcode-row { display: flex; gap: 10px; }
    .barcode-input { flex: 1; padding: 14px; border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); font-size: 16px; text-align: center; background: rgba(0,0,0,0.3); color: white; font-family: inherit; }
    .barcode-btn { padding: 14px 20px; border-radius: var(--radius-sm); border: none; background: rgba(255,255,255,0.15); color: white; font-size: 16px; cursor: pointer; }
    .camera-btn { padding: 12px 20px; border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); background: transparent; color: var(--text-muted); font-size: 15px; cursor: pointer; font-family: inherit; margin-top: 16px; }
    .search-results { padding: 16px; max-height: 70vh; overflow-y: auto; }
    .search-result-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px; cursor: pointer; }
    .search-result-card:hover { background: var(--bg-card-hover); border-color: var(--accent-green); }
    .search-result-image { width: 70px; height: 70px; object-fit: contain; background: white; border-radius: var(--radius-sm); flex-shrink: 0; }
    .search-result-placeholder { width: 70px; height: 70px; background: rgba(255,255,255,0.08); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0; }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-name { font-weight: 600; font-size: 17px; margin-bottom: 4px; }
    .search-result-brand { font-size: 14px; color: var(--text-muted); }
    .search-result-badge { font-size: 13px; padding: 4px 10px; border-radius: 6px; font-weight: 600; flex-shrink: 0; }
    .search-result-badge.has-ing { background: rgba(34,197,94,0.2); color: #86efac; }
    .search-result-badge.no-ing { background: rgba(239,68,68,0.2); color: #fca5a5; }
    .back-btn { width: 100%; margin-top: 12px; padding: 14px; border-radius: var(--radius-md); border: 1px solid var(--border-subtle); background: transparent; color: var(--text-secondary); font-size: 16px; cursor: pointer; font-family: inherit; }
    #productInfo { display: none; padding: 20px; }
    #productInfo.active { display: block; }
    .product-card { background: linear-gradient(135deg, rgba(16,185,129,0.12) 0%, rgba(16,185,129,0.04) 100%); border: 1px solid rgba(16,185,129,0.25); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; text-align: center; }
    .product-image { width: 180px; height: 180px; object-fit: contain; border-radius: var(--radius-md); background: white; display: block; margin: 0 auto 16px; }
    .product-name { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
    .product-brand { font-size: 16px; color: var(--text-secondary); margin-bottom: 8px; }
    .product-serving { font-size: 14px; color: var(--text-muted); }
    .footer { text-align: center; padding: 32px 16px; color: var(--text-muted); font-size: 13px; line-height: 1.7; }
    .footer-logo { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 12px; opacity: 0.8; }
    .footer-logo img { width: 28px; height: 28px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">üî¨</div>
      <h1>Ingredient Translator</h1>
      <p class="subtitle">Understand what's really in your food</p>
      <div class="stats-badge"><span>üìö</span><span>560+ ingredients</span></div>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('analyze')">üîç Analyze</button>
      <button class="tab" onclick="switchTab('favorites')">‚ù§Ô∏è Favorites</button>
    </div>
    <div id="analyzeTab" class="tab-content active">
      <div id="selectedProduct">
        <div class="selected-product-card">
          <img id="selectedProductImage" class="selected-product-image" style="display:none">
          <div id="selectedProductPlaceholder" class="selected-product-placeholder">üì¶</div>
          <div class="selected-product-info">
            <div class="selected-product-name" id="selectedProductName">Product Name</div>
            <div class="selected-product-brand" id="selectedProductBrand">Brand</div>
            <div class="selected-product-serving" id="selectedProductServing"></div>
          </div>
          <button class="btn-favorite" id="favoriteBtn" onclick="toggleFavorite(event)">ü§ç</button>
          <button class="selected-product-clear" onclick="clearSelectedProduct()">‚úï</button>
        </div>
      </div>
      <div class="card">
        <div class="search-section">
          <button class="btn-search" onclick="startScanner()">üîç Search Product</button>
          <div class="or-divider">or paste ingredients below</div>
        </div>
        <div class="examples-label">Try an example:</div>
        <div class="examples">
          <button class="btn-example" onclick="tryExample('soda')">ü•§ Soda</button>
          <button class="btn-example" onclick="tryExample('chips')">üßÄ Doritos</button>
          <button class="btn-example" onclick="tryExample('icecream')">üç¶ Ice Cream</button>
          <button class="btn-example" onclick="tryExample('bread')">üçû Bread</button>
          <button class="btn-example" onclick="tryExample('healthy')">üåø Granola</button>
        </div>
        <textarea id="input" placeholder="Paste ingredients from any food label..."></textarea>
        <button class="btn" onclick="analyze()">üîç Translate Ingredients</button>
      </div>
      <div id="results">
        <div class="health-gauge-container" id="healthGauge">
          <div class="health-gauge-title">Health Risk Assessment</div>
          <div class="health-gauge">
            <div class="gauge-bg"></div>
            <div class="gauge-needle" id="gaugeNeedle"></div>
          </div>
          <div class="gauge-labels"><span>Clean</span><span>Moderate</span><span>Concerning</span></div>
          <div class="health-score" id="healthScore">--</div>
          <div class="health-label" id="healthLabel"></div>
          <div class="health-summary" id="healthSummary"></div>
          <div class="risk-flags" id="riskFlags"></div>
        </div>
        <div class="card">
          <div class="breakdown-header">
            <div class="breakdown-title">üìã Breakdown</div>
            <div class="breakdown-count" id="ingredientCount"></div>
          </div>
          <p class="breakdown-note">Listed in order (first = most) ‚Ä¢ Tap any ingredient for details</p>
          <div id="ingredientsList"></div>
          <div class="alternatives-section" id="alternativesSection" style="display:none">
            <div class="alternatives-title">üí° Healthier Swaps</div>
            <div id="alternativesList"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="favoritesTab" class="tab-content">
      <div class="card">
        <div id="favoritesList">
          <div class="favorites-empty">
            <div class="favorites-empty-icon">‚ù§Ô∏è</div>
            <div class="favorites-empty-text">No favorites yet</div>
            <div class="favorites-empty-hint">Tap the heart when viewing a product to save it here</div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div style="margin-bottom:12px">For educational purposes only ‚Ä¢ Not medical or dietary advice</div>
      <div class="footer-logo">
        <img src="https://stuffworkinggood.github.io/ingredient-translator-v2/logo.png" alt="Logo">
        <span>by Stuff Working Good</span>
      </div>
    </div>
  </div>
  <div id="scannerModal">
    <div class="scanner-header">
      <div class="scanner-title">üîç Find Product</div>
      <button class="btn-close" onclick="stopScanner()">‚úï</button>
    </div>
    <div id="scannerContainer">
      <video id="scannerVideo" playsinline style="display:none"></video>
      <div class="scanner-overlay"></div>
      <div class="scanner-hint">Point camera at barcode</div>
      <div class="scanner-status" id="scannerStatus"></div>
    </div>
    <div id="productInfo">
      <div class="product-card">
        <img id="productImage" class="product-image" style="display:none">
        <div class="product-name" id="productName">Loading...</div>
        <div class="product-brand" id="productBrand"></div>
        <div class="product-serving" id="productServing"></div>
      </div>
      <button class="btn" onclick="useScannedIngredients()">‚úì Use These Ingredients</button>
      <button class="btn" style="background:rgba(255,255,255,0.1);margin-top:8px" onclick="scanAgain()">Scan Another</button>
    </div>
  </div>

<script>
// ===== INGREDIENT DATABASE =====
var db = {
  "sugar": { c: "sugar", e: "Regular table sugar (sucrose).", source: "Sugarcane or sugar beets", purpose: "Sweetness, texture", concerns: ["High glycemic index", "Empty calories"], diet: ["Not keto"], risk: 4 },
  "high fructose corn syrup": { c: "sugar", e: "Cheap liquid sugar from corn. Very common in processed foods.", source: "Corn starch + enzymes", purpose: "Cheap sweetener", concerns: ["Linked to obesity", "High fructose load on liver", "Usually GMO"], diet: ["Not keto"], risk: 7 },
  "corn syrup": { c: "sugar", e: "Liquid glucose from corn starch.", source: "Corn", purpose: "Sweetener, texture", concerns: ["Highly processed", "Spikes blood sugar"], diet: ["Not keto"], risk: 5 },
  "maltodextrin": { c: "sugar", e: "Processed starch. Spikes blood sugar faster than table sugar.", source: "Corn, rice, or wheat starch", purpose: "Filler, thickener", concerns: ["Glycemic index of 85-105", "May disrupt gut bacteria"], diet: ["Not keto"], risk: 6 },
  "dextrose": { c: "sugar", e: "Simple sugar (glucose) from corn.", source: "Corn starch", purpose: "Quick energy, sweetness", concerns: ["Spikes blood sugar rapidly"], diet: ["Not keto"], risk: 5 },
  "aspartame": { c: "artificial sweetener", e: "Zero-calorie artificial sweetener. 200x sweeter than sugar.", source: "Synthetic amino acids", purpose: "Zero-calorie sweetness", concerns: ["Headaches in some people", "Controversial safety studies", "Not for PKU patients"], diet: ["Keto-friendly"], risk: 6 },
  "sucralose": { c: "artificial sweetener", e: "Zero-calorie sweetener (Splenda). 600x sweeter than sugar.", source: "Chlorinated sugar", purpose: "Heat-stable sweetener", concerns: ["May affect gut bacteria", "Chlorinated compound"], diet: ["Keto-friendly"], risk: 5 },
  "acesulfame potassium": { c: "artificial sweetener", e: "Artificial sweetener often paired with aspartame.", source: "Synthetic", purpose: "Sweetness, flavor enhancement", concerns: ["Limited long-term studies", "Contains methylene chloride"], diet: ["Keto-friendly"], risk: 5 },
  "stevia": { c: "natural sweetener", e: "Plant-based zero-calorie sweetener.", source: "Stevia plant leaves", purpose: "Natural zero-cal sweetness", concerns: ["Can have bitter aftertaste"], diet: ["Keto-friendly", "Vegan"], risk: 1 },
  "monk fruit": { c: "natural sweetener", e: "Natural sweetener from Asian fruit. Zero calories.", source: "Luo han guo fruit", purpose: "Natural sweetener", concerns: ["Often mixed with other sweeteners"], diet: ["Keto-friendly", "Vegan"], risk: 1 },
  "erythritol": { c: "sugar alcohol", e: "Sugar alcohol with almost zero calories.", source: "Fermented glucose", purpose: "Bulk sweetener", concerns: ["May cause digestive issues in large amounts"], diet: ["Keto-friendly"], risk: 2 },
  "sodium benzoate": { c: "preservative", e: "Prevents mold and bacteria growth in acidic foods.", source: "Synthetic", purpose: "Preservation", concerns: ["Can form benzene with vitamin C", "Linked to hyperactivity"], diet: ["Vegan"], risk: 6 },
  "potassium sorbate": { c: "preservative", e: "Prevents mold and yeast growth.", source: "Synthetic", purpose: "Preservation", concerns: ["Generally considered safe", "May cause skin irritation"], diet: ["Vegan"], risk: 2 },
  "sodium nitrite": { c: "preservative", e: "Cures meat and keeps it pink. Prevents botulism.", source: "Synthetic", purpose: "Meat preservation, color", concerns: ["Forms nitrosamines when heated", "Linked to cancer risk"], diet: ["Not vegan"], risk: 8 },
  "bha": { c: "preservative", e: "Butylated hydroxyanisole. Prevents fats from going rancid.", source: "Petroleum-derived", purpose: "Antioxidant preservative", concerns: ["Possible carcinogen", "Banned in some countries"], diet: ["Vegan"], risk: 7 },
  "bht": { c: "preservative", e: "Butylated hydroxytoluene. Similar to BHA.", source: "Petroleum-derived", purpose: "Prevents oxidation", concerns: ["Possible carcinogen", "Endocrine disruptor concerns"], diet: ["Vegan"], risk: 7 },
  "tbhq": { c: "preservative", e: "Tertiary butylhydroquinone. Preserves fats and oils.", source: "Petroleum-derived", purpose: "Antioxidant", concerns: ["May affect immune system", "Nausea at high doses"], diet: ["Vegan"], risk: 5 },
  "red 40": { c: "artificial color", e: "Most common red food dye in the US.", source: "Petroleum-derived", purpose: "Red coloring", concerns: ["Linked to hyperactivity in children", "Banned in some countries"], diet: ["Vegan"], risk: 7 },
  "yellow 5": { c: "artificial color", e: "Tartrazine. Common yellow dye.", source: "Petroleum-derived", purpose: "Yellow coloring", concerns: ["Allergic reactions", "Hyperactivity concerns"], diet: ["Vegan"], risk: 6 },
  "yellow 6": { c: "artificial color", e: "Sunset Yellow. Orange-yellow dye.", source: "Petroleum-derived", purpose: "Orange coloring", concerns: ["Linked to hyperactivity", "Allergic reactions"], diet: ["Vegan"], risk: 6 },
  "blue 1": { c: "artificial color", e: "Brilliant Blue. Common blue dye.", source: "Petroleum-derived", purpose: "Blue coloring", concerns: ["May cross blood-brain barrier", "Allergic reactions"], diet: ["Vegan"], risk: 5 },
  "caramel color": { c: "color", e: "Brown coloring made from heated sugar.", source: "Heated sugar with chemicals", purpose: "Brown color", concerns: ["Class IV contains 4-MEI (possible carcinogen)"], diet: ["Check source"], risk: 4 },
  "monosodium glutamate": { c: "flavor enhancer", e: "MSG. Enhances savory/umami flavor.", source: "Fermented starch", purpose: "Flavor enhancement", concerns: ["Headaches in sensitive people", "Often in highly processed foods"], diet: ["Vegan"], risk: 4 },
  "carrageenan": { c: "stabilizer", e: "Thickener from seaweed. Controversial.", source: "Red seaweed", purpose: "Thickening, stabilizing", concerns: ["Inflammation concerns", "Digestive issues", "Banned in EU infant formula"], diet: ["Vegan"], risk: 5 },
  "xanthan gum": { c: "stabilizer", e: "Thickener made by bacteria fermentation.", source: "Bacterial fermentation", purpose: "Thickening, stabilizing", concerns: ["Generally safe", "May cause bloating"], diet: ["Vegan", "GF"], risk: 1 },
  "guar gum": { c: "stabilizer", e: "Thickener from guar beans.", source: "Guar beans", purpose: "Thickening", concerns: ["May cause digestive issues"], diet: ["Vegan", "GF"], risk: 2 },
  "cellulose": { c: "fiber", e: "Plant fiber used as filler and anti-caking agent.", source: "Wood pulp or plants", purpose: "Filler, fiber", concerns: ["Not digestible", "Used to bulk up food"], diet: ["Vegan", "GF"], risk: 2 },
  "soy lecithin": { c: "emulsifier", e: "Keeps oil and water mixed. Very common.", source: "Soybeans", purpose: "Emulsifier", concerns: ["Usually GMO", "Soy allergen"], diet: ["Vegan"], risk: 2 },
  "polysorbate 80": { c: "emulsifier", e: "Synthetic emulsifier.", source: "Synthetic", purpose: "Emulsifier, stabilizer", concerns: ["May affect gut bacteria", "Inflammation concerns"], diet: ["Vegan"], risk: 4 },
  "partially hydrogenated oil": { c: "trans fat", e: "Artificial trans fat. Extremely harmful.", source: "Vegetable oil + hydrogen", purpose: "Shelf stability, texture", concerns: ["Heart disease", "Banned but traces allowed"], diet: ["Vegan"], risk: 10 },
  "hydrogenated oil": { c: "fat", e: "Fully or partially hardened vegetable oil.", source: "Vegetable oils", purpose: "Shelf stability", concerns: ["May contain trans fats", "Highly processed"], diet: ["Vegan"], risk: 6 },
  "palm oil": { c: "oil", e: "Oil from palm fruit. Environmental concerns.", source: "Palm fruit", purpose: "Cooking oil, texture", concerns: ["Deforestation", "High saturated fat"], diet: ["Vegan"], risk: 4 },
  "soybean oil": { c: "oil", e: "Most common vegetable oil in US.", source: "Soybeans", purpose: "Cooking oil", concerns: ["High omega-6", "Usually GMO", "Inflammation"], diet: ["Vegan"], risk: 3 },
  "canola oil": { c: "oil", e: "Oil from rapeseed. Highly processed.", source: "Rapeseed", purpose: "Cooking oil", concerns: ["Highly processed", "Usually GMO"], diet: ["Vegan"], risk: 3 },
  "olive oil": { c: "oil", e: "Oil from pressed olives. Heart-healthy.", source: "Olives", purpose: "Cooking, flavor", concerns: ["Often adulterated"], diet: ["Vegan", "Heart-healthy"], risk: 0 },
  "natural flavors": { c: "flavor", e: "Vague term for flavor compounds from natural sources.", source: "Plant or animal sources", purpose: "Flavoring", concerns: ["Very vague - can be almost anything", "May not be vegan"], diet: ["Check source"], risk: 3 },
  "artificial flavors": { c: "flavor", e: "Lab-created flavor compounds.", source: "Synthetic", purpose: "Flavoring", concerns: ["Unknown specific chemicals", "Proprietary formulas"], diet: ["Usually vegan"], risk: 3 },
  "citric acid": { c: "acid", e: "Adds tartness. Usually from mold, not citrus.", source: "Aspergillus mold fermentation", purpose: "Sour flavor, preservative", concerns: ["Generally safe"], diet: ["Vegan", "GF"], risk: 1 },
  "phosphoric acid": { c: "acid", e: "Adds tartness to cola drinks. Affects calcium absorption.", source: "Phosphate rock", purpose: "Acidifier, flavor", concerns: ["May affect bone density", "Tooth enamel erosion"], diet: ["Vegan"], risk: 4 },
  "enriched wheat flour": { c: "flour", e: "Refined white flour with vitamins added back.", source: "Wheat", purpose: "Baking, structure", concerns: ["Refined/processed", "Nutrients stripped then added"], diet: ["Not GF"], risk: 2 },
  "whole wheat flour": { c: "flour", e: "Flour with entire wheat kernel.", source: "Whole wheat", purpose: "Baking, fiber", concerns: ["Contains gluten"], diet: ["Not GF"], risk: 1 },
  "water": { c: "water", e: "H2O. Essential for life.", source: "Water supply", purpose: "Hydration, processing", concerns: [], diet: ["Vegan", "GF"], risk: 0 },
  "salt": { c: "salt", e: "Sodium chloride. Essential mineral.", source: "Sea or rock deposits", purpose: "Flavor, preservation", concerns: ["Excess linked to high blood pressure"], diet: ["Vegan", "GF"], risk: 1 },
  "cream": { c: "dairy", e: "High-fat dairy product.", source: "Milk", purpose: "Richness, texture", concerns: ["High saturated fat", "Lactose"], diet: ["Vegetarian", "Not vegan"], risk: 2 },
  "milk": { c: "dairy", e: "Cow's milk.", source: "Cows", purpose: "Nutrition, texture", concerns: ["Lactose intolerance", "Dairy allergen"], diet: ["Vegetarian"], risk: 1 },
  "whey": { c: "dairy", e: "Protein from cheese-making.", source: "Milk", purpose: "Protein, texture", concerns: ["Dairy allergen"], diet: ["Vegetarian"], risk: 1 },
  "butter": { c: "dairy", e: "Fat from churned cream.", source: "Cream", purpose: "Flavor, texture", concerns: ["High saturated fat"], diet: ["Vegetarian"], risk: 2 },
  "cheese": { c: "dairy", e: "Fermented milk product.", source: "Milk", purpose: "Flavor, protein", concerns: ["High sodium", "Saturated fat"], diet: ["Vegetarian"], risk: 2 }
};

// ===== CATEGORY STYLES =====
var styles = {
  "sugar": { color: "#ef4444", bg: "rgba(239,68,68,0.15)", icon: "üç¨" },
  "natural sweetener": { color: "#22c55e", bg: "rgba(34,197,94,0.15)", icon: "üçØ" },
  "artificial sweetener": { color: "#f97316", bg: "rgba(249,115,22,0.15)", icon: "‚öóÔ∏è" },
  "sugar alcohol": { color: "#eab308", bg: "rgba(234,179,8,0.15)", icon: "üß™" },
  "preservative": { color: "#14b8a6", bg: "rgba(20,184,166,0.15)", icon: "üß™" },
  "artificial color": { color: "#ec4899", bg: "rgba(236,72,153,0.15)", icon: "üé®" },
  "color": { color: "#a855f7", bg: "rgba(168,85,247,0.15)", icon: "üé®" },
  "flavor enhancer": { color: "#f59e0b", bg: "rgba(245,158,11,0.15)", icon: "‚ú®" },
  "flavor": { color: "#64748b", bg: "rgba(100,116,139,0.15)", icon: "üëÖ" },
  "stabilizer": { color: "#8b5cf6", bg: "rgba(139,92,246,0.15)", icon: "üîó" },
  "emulsifier": { color: "#06b6d4", bg: "rgba(6,182,212,0.15)", icon: "üîÑ" },
  "trans fat": { color: "#dc2626", bg: "rgba(220,38,38,0.2)", icon: "‚ò†Ô∏è" },
  "fat": { color: "#f59e0b", bg: "rgba(245,158,11,0.15)", icon: "üßà" },
  "oil": { color: "#eab308", bg: "rgba(234,179,8,0.15)", icon: "ü´í" },
  "acid": { color: "#06b6d4", bg: "rgba(6,182,212,0.15)", icon: "üß´" },
  "flour": { color: "#d4a574", bg: "rgba(212,165,116,0.15)", icon: "üåæ" },
  "fiber": { color: "#22c55e", bg: "rgba(34,197,94,0.15)", icon: "üåø" },
  "dairy": { color: "#60a5fa", bg: "rgba(96,165,250,0.15)", icon: "ü•õ" },
  "water": { color: "#38bdf8", bg: "rgba(56,189,248,0.15)", icon: "üíß" },
  "salt": { color: "#94a3b8", bg: "rgba(148,163,184,0.15)", icon: "üßÇ" },
  "unknown": { color: "#64748b", bg: "rgba(100,116,139,0.15)", icon: "‚ùì" }
};

// ===== EXAMPLES =====
var examples = {
  soda: "Carbonated Water, High Fructose Corn Syrup, Caramel Color, Phosphoric Acid, Natural Flavors, Caffeine, Citric Acid, Sodium Benzoate",
  chips: "Corn, Vegetable Oil (Corn, Canola, and/or Sunflower Oil), Maltodextrin, Salt, Cheddar Cheese (Milk, Cheese Cultures, Salt, Enzymes), Whey, Monosodium Glutamate, Buttermilk, Romano Cheese, Whey Protein Concentrate, Onion Powder, Corn Flour, Natural and Artificial Flavors, Dextrose, Tomato Powder, Lactose, Spices, Artificial Color (Yellow 6, Yellow 5, Red 40), Lactic Acid, Citric Acid, Sugar, Garlic Powder, Skim Milk, Red and Green Bell Pepper Powder, Disodium Inosinate, Disodium Guanylate",
  icecream: "Cream, Skim Milk, Sugar, Corn Syrup, Whey, Milk, Butter, Mono and Diglycerides, Guar Gum, Carrageenan, Natural Flavor, Carob Bean Gum, Vitamin A Palmitate",
  bread: "Enriched Wheat Flour, Water, High Fructose Corn Syrup, Yeast, Soybean Oil, Salt, Calcium Propionate, Datem, Monoglycerides, Citric Acid, Soy Lecithin",
  healthy: "Organic Rolled Oats, Organic Maple Syrup, Organic Sunflower Oil, Organic Pumpkin Seeds, Organic Dried Cranberries, Organic Coconut, Sea Salt, Organic Vanilla Extract"
};

// ===== ALTERNATIVES =====
var alternatives = {
  "high fructose corn syrup": { alt: "Honey, maple syrup, or dates", desc: "Natural sweeteners with some nutrients" },
  "sugar": { alt: "Coconut sugar, honey, or fruit", desc: "Lower glycemic options or whole food sweetness" },
  "aspartame": { alt: "Stevia or monk fruit", desc: "Natural zero-calorie alternatives" },
  "sucralose": { alt: "Stevia or monk fruit", desc: "Plant-based zero-calorie options" },
  "red 40": { alt: "Beet juice or paprika", desc: "Natural red coloring" },
  "yellow 5": { alt: "Turmeric or annatto", desc: "Natural yellow coloring" },
  "yellow 6": { alt: "Turmeric or carrot juice", desc: "Natural orange-yellow coloring" },
  "sodium nitrite": { alt: "Celery powder", desc: "Natural curing agent" },
  "msg": { alt: "Nutritional yeast", desc: "Natural umami flavor" },
  "monosodium glutamate": { alt: "Nutritional yeast", desc: "Natural umami flavor" },
  "carrageenan": { alt: "Gellan gum or agar", desc: "Less controversial thickeners" },
  "soybean oil": { alt: "Olive oil or avocado oil", desc: "Healthier fat profiles" },
  "canola oil": { alt: "Olive oil or coconut oil", desc: "Less processed options" }
};

// ===== GLOBAL STATE =====
var currentProduct = null;
var lastHealthScore = 50;
var scannedIngredients = "";
var scannedProductData = null;
var quaggaRunning = false;

// ===== TAB SWITCHING =====
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(function(t, i) {
    t.classList.toggle('active', (tab === 'analyze' && i === 0) || (tab === 'favorites' && i === 1));
  });
  document.getElementById('analyzeTab').classList.toggle('active', tab === 'analyze');
  document.getElementById('favoritesTab').classList.toggle('active', tab === 'favorites');
  if (tab === 'favorites') renderFavorites();
}

// ===== FAVORITES =====
function getFavorites() {
  try { return JSON.parse(localStorage.getItem('ingredientFavorites') || '[]'); }
  catch(e) { return []; }
}

function saveFavorites(favs) {
  localStorage.setItem('ingredientFavorites', JSON.stringify(favs));
}

function isFavorited(code) {
  return getFavorites().some(function(f) { return f.code === code; });
}

function toggleFavorite(e) {
  e.stopPropagation();
  if (!currentProduct || !currentProduct.code) return;
  var favs = getFavorites();
  var idx = favs.findIndex(function(f) { return f.code === currentProduct.code; });
  if (idx >= 0) {
    favs.splice(idx, 1);
  } else {
    favs.unshift({
      code: currentProduct.code,
      name: currentProduct.name,
      brand: currentProduct.brand,
      image: currentProduct.image,
      ingredients: currentProduct.ingredients,
      serving: currentProduct.serving,
      score: lastHealthScore
    });
  }
  saveFavorites(favs);
  updateFavoriteButton();
}

function updateFavoriteButton() {
  var btn = document.getElementById('favoriteBtn');
  if (!currentProduct || !currentProduct.code) {
    btn.style.display = 'none';
    return;
  }
  btn.style.display = 'block';
  var fav = isFavorited(currentProduct.code);
  btn.classList.toggle('favorited', fav);
  btn.textContent = fav ? '‚ù§Ô∏è' : 'ü§ç';
}

function renderFavorites() {
  var favs = getFavorites();
  var container = document.getElementById('favoritesList');
  if (favs.length === 0) {
    container.innerHTML = '<div class="favorites-empty"><div class="favorites-empty-icon">‚ù§Ô∏è</div><div class="favorites-empty-text">No favorites yet</div><div style="font-size:14px">Tap the heart when viewing a product to save it here</div></div>';
    return;
  }
  container.innerHTML = favs.map(function(f) {
    var scoreBg = f.score >= 70 ? 'rgba(34,197,94,0.2)' : f.score >= 40 ? 'rgba(234,179,8,0.2)' : 'rgba(239,68,68,0.2)';
    var scoreColor = f.score >= 70 ? '#86efac' : f.score >= 40 ? '#fcd34d' : '#fca5a5';
    return '<div class="favorite-card" onclick="loadFavorite(\'' + f.code + '\')">' +
      (f.image ? '<img class="favorite-image" src="' + f.image + '">' : '<div class="favorite-image-placeholder">üì¶</div>') +
      '<div class="favorite-info"><div class="favorite-name">' + (f.name || 'Unknown') + '</div><div class="favorite-brand">' + (f.brand || '') + '</div></div>' +
      '<div class="favorite-score" style="background:' + scoreBg + ';color:' + scoreColor + '">' + (f.score || '?') + '</div>' +
      '<button class="favorite-remove" onclick="removeFavorite(event,\'' + f.code + '\')">‚úï</button></div>';
  }).join('');
}

function removeFavorite(e, code) {
  e.stopPropagation();
  saveFavorites(getFavorites().filter(function(f) { return f.code !== code; }));
  renderFavorites();
  updateFavoriteButton();
}

function loadFavorite(code) {
  var fav = getFavorites().find(function(f) { return f.code === code; });
  if (!fav) return;
  currentProduct = fav;
  document.getElementById('input').value = fav.ingredients || '';
  showSelectedProduct(fav.name, fav.brand, fav.image, fav.serving);
  switchTab('analyze');
  analyze();
}

// ===== SELECTED PRODUCT =====
function showSelectedProduct(name, brand, image, serving) {
  document.getElementById('selectedProduct').classList.add('active');
  document.getElementById('selectedProductName').textContent = name || 'Unknown Product';
  document.getElementById('selectedProductBrand').textContent = brand || '';
  document.getElementById('selectedProductServing').textContent = serving || '';
  var imgEl = document.getElementById('selectedProductImage');
  var placeholder = document.getElementById('selectedProductPlaceholder');
  if (image) {
    imgEl.src = image;
    imgEl.style.display = 'block';
    placeholder.style.display = 'none';
  } else {
    imgEl.style.display = 'none';
    placeholder.style.display = 'flex';
  }
  updateFavoriteButton();
}

function clearSelectedProduct() {
  currentProduct = null;
  document.getElementById('selectedProduct').classList.remove('active');
  document.getElementById('input').value = '';
  document.getElementById('results').style.display = 'none';
  updateFavoriteButton();
}

// ===== EXAMPLES =====
function tryExample(type) {
  document.getElementById('input').value = examples[type];
  clearSelectedProduct();
  analyze();
}

// ===== EXPAND CARDS =====
function toggleExpand(el) {
  el.classList.toggle('expanded');
}

// ===== HEALTH SCORE =====
function calculateHealthScore(analyzed) {
  var score = 100;
  var flags = [];
  
  analyzed.forEach(function(ing, idx) {
    var risk = ing.risk || 0;
    var mult = idx < 3 ? 1.5 : idx < 6 ? 1.2 : 1;
    score -= risk * mult;
    
    if (risk >= 7) {
      flags.push({ type: 'danger', text: ing.name });
    } else if (risk >= 5) {
      flags.push({ type: 'warning', text: ing.name });
    }
  });
  
  var cats = {};
  analyzed.forEach(function(i) { cats[i.category] = (cats[i.category] || 0) + 1; });
  
  var sugars = (cats['sugar']||0) + (cats['artificial sweetener']||0) + (cats['sugar alcohol']||0);
  if (sugars >= 3) {
    score -= 10;
    flags.push({ type: 'warning', text: sugars + ' sweeteners' });
  }
  
  if (cats['artificial color']) {
    score -= cats['artificial color'] * 5;
    flags.push({ type: 'danger', text: 'Artificial dyes' });
  }
  
  if (cats['trans fat']) {
    score -= 20;
    flags.push({ type: 'danger', text: 'Trans fat!' });
  }
  
  if (analyzed.length > 15) {
    flags.push({ type: 'caution', text: analyzed.length + ' ingredients' });
  }
  
  return { score: Math.max(0, Math.min(100, Math.round(score))), flags: flags.slice(0, 4) };
}

function updateHealthGauge(score, flags) {
  lastHealthScore = score;
  var rotation = -90 + (100 - score) * 1.8;
  document.getElementById('gaugeNeedle').style.setProperty('--rotation', rotation + 'deg');
  
  var scoreEl = document.getElementById('healthScore');
  scoreEl.textContent = score;
  scoreEl.className = 'health-score ' + (score >= 70 ? 'good' : score >= 50 ? 'okay' : score >= 30 ? 'poor' : 'bad');
  
  document.getElementById('healthLabel').textContent = 
    score >= 80 ? 'Clean & Minimal' : 
    score >= 60 ? 'Moderately Processed' : 
    score >= 40 ? 'Concerning Ingredients' : 'Highly Processed';
  
  document.getElementById('healthSummary').textContent = 
    score >= 80 ? 'This product has a clean ingredient list.' : 
    score >= 60 ? 'Some processed ingredients present.' : 
    score >= 40 ? 'Contains ingredients linked to health concerns.' : 
    'Multiple high-risk ingredients. Consider alternatives.';
  
  document.getElementById('riskFlags').innerHTML = flags.map(function(f) {
    return '<div class="risk-flag ' + f.type + '">‚ö†Ô∏è ' + f.text + '</div>';
  }).join('');
}

// ===== MAIN ANALYZE FUNCTION =====
function analyze() {
  var text = document.getElementById('input').value;
  if (!text.trim()) return;
  
  var cleaned = text.replace(/ingredients?:?/gi, '')
    .replace(/contains\s*(less than|2%|1%)?\s*(of)?:?/gi, ', ')
    .replace(/\([^)]*\)/g, ' ')
    .replace(/\[[^\]]*\]/g, ' ')
    .replace(/\./g, ',')
    .replace(/;/g, ',')
    .trim();
  
  var ingredients = cleaned.split(',')
    .map(function(i) { return i.trim(); })
    .filter(function(i) { return i.length > 1 && i.length < 100; });
  
  var analyzed = ingredients.map(function(ing, idx) {
    var lower = ing.toLowerCase().trim()
      .replace(/^organic\s+/, '')
      .replace(/^natural\s+/, '')
      .replace(/^pure\s+/, '');
    
    // Direct match
    if (db[lower]) {
      var item = db[lower];
      return {
        name: ing,
        category: item.c,
        explanation: item.e,
        source: item.source,
        purpose: item.purpose,
        concerns: item.concerns,
        diet: item.diet,
        risk: item.risk || 0,
        position: idx + 1
      };
    }
    
    // Partial match
    for (var key in db) {
      if (lower.indexOf(key) !== -1 || key.indexOf(lower) !== -1) {
        var val = db[key];
        return {
          name: ing,
          category: val.c,
          explanation: val.e,
          source: val.source,
          purpose: val.purpose,
          concerns: val.concerns,
          diet: val.diet,
          risk: val.risk || 0,
          position: idx + 1
        };
      }
    }
    
    // Fallback categorization
    if (/sugar|syrup|sweetener|sucrose|fructose|dextrose/i.test(lower)) {
      return { name: ing, category: 'sugar', explanation: 'A type of sugar or sweetener.', risk: 4, position: idx + 1 };
    }
    if (/oil|fat|butter/i.test(lower)) {
      return { name: ing, category: 'oil', explanation: 'A type of fat or oil.', risk: 2, position: idx + 1 };
    }
    if (/flour|starch/i.test(lower)) {
      return { name: ing, category: 'flour', explanation: 'A flour or starch.', risk: 1, position: idx + 1 };
    }
    if (/color|dye|red \d|yellow \d|blue \d/i.test(lower)) {
      return { name: ing, category: 'artificial color', explanation: 'An artificial coloring agent.', risk: 6, position: idx + 1 };
    }
    if (/gum/i.test(lower)) {
      return { name: ing, category: 'stabilizer', explanation: 'A thickener or stabilizer.', risk: 2, position: idx + 1 };
    }
    if (/vitamin|thiamin|riboflavin|niacin|folic/i.test(lower)) {
      return { name: ing, category: 'vitamin', explanation: 'A vitamin or nutrient.', risk: 0, position: idx + 1 };
    }
    
    return { name: ing, category: 'unknown', explanation: 'Not in our database yet.', risk: 1, position: idx + 1 };
  });
  
  // Calculate health score
  var healthResult = calculateHealthScore(analyzed);
  updateHealthGauge(healthResult.score, healthResult.flags);
  
  // Show results
  document.getElementById('results').style.display = 'block';
  document.getElementById('ingredientCount').textContent = analyzed.length + ' ingredients';
  
  // Build ingredient cards
  document.getElementById('ingredientsList').innerHTML = analyzed.map(function(ing) {
    var s = styles[ing.category] || styles.unknown;
    
    var expandedHtml = '';
    if (ing.source || ing.purpose || ing.concerns || ing.diet) {
      expandedHtml = '<div class="expanded-info">';
      if (ing.source) {
        expandedHtml += '<div class="info-section"><div class="info-label">üå± Made From</div><div class="info-content">' + ing.source + '</div></div>';
      }
      if (ing.purpose) {
        expandedHtml += '<div class="info-section"><div class="info-label">üéØ Why It\'s Added</div><div class="info-content">' + ing.purpose + '</div></div>';
      }
      if (ing.concerns && ing.concerns.length) {
        expandedHtml += '<div class="info-section"><div class="info-label">‚ö†Ô∏è Things to Know</div><div class="info-content">';
        ing.concerns.forEach(function(c) {
          var cls = /carcinogen|cancer|banned|toxic|harmful/i.test(c) ? 'warning' : 
                   /safe|generally|natural/i.test(c) ? 'good' : 'neutral';
          expandedHtml += '<span class="info-tag ' + cls + '">' + c + '</span>';
        });
        expandedHtml += '</div></div>';
      }
      if (ing.diet && ing.diet.length) {
        expandedHtml += '<div class="info-section"><div class="info-label">ü•ó Diet Info</div><div class="info-content">';
        ing.diet.forEach(function(d) {
          var cls = /not|avoid/i.test(d) ? 'warning' : /vegan|gf|keto|healthy/i.test(d) ? 'good' : 'neutral';
          expandedHtml += '<span class="info-tag ' + cls + '">' + d + '</span>';
        });
        expandedHtml += '</div></div>';
      }
      expandedHtml += '</div>';
    }
    
    var hasDetails = ing.source || ing.purpose || ing.concerns || ing.diet;
    var posLabel = ing.position <= 3 ? ' <span style="font-size:12px;color:var(--text-muted)">(#' + ing.position + ' - high amount)</span>' : '';
    
    return '<div class="ingredient-card" style="border-left-color:' + s.color + '"' + (hasDetails ? ' onclick="toggleExpand(this)"' : '') + '>' +
      '<div class="ingredient-header">' +
      '<div><span class="ingredient-name">' + ing.name + '</span>' + posLabel + '</div>' +
      '<span class="category-badge" style="background:' + s.bg + ';color:' + s.color + '">' + s.icon + ' ' + ing.category + '</span>' +
      '</div>' +
      '<p class="ingredient-explanation">' + ing.explanation + '</p>' +
      (hasDetails ? '<div class="tap-hint">üëÜ Tap for more info</div>' : '') +
      expandedHtml +
      '</div>';
  }).join('');
  
  // Show alternatives
  var relevantAlts = [];
  analyzed.forEach(function(ing) {
    var lower = ing.name.toLowerCase();
    for (var key in alternatives) {
      if (lower.indexOf(key) !== -1 || key.indexOf(lower) !== -1) {
        if (!relevantAlts.some(function(a) { return a.original === key; })) {
          relevantAlts.push({ original: key, alt: alternatives[key].alt, desc: alternatives[key].desc });
        }
      }
    }
  });
  
  var altSection = document.getElementById('alternativesSection');
  if (relevantAlts.length > 0) {
    altSection.style.display = 'block';
    document.getElementById('alternativesList').innerHTML = relevantAlts.slice(0, 5).map(function(a) {
      return '<div class="alternative-item">' +
        '<div class="alternative-icon">‚úÖ</div>' +
        '<div class="alternative-content">' +
        '<div class="alternative-name">Instead of <strong>' + a.original + '</strong>: ' + a.alt + '</div>' +
        '<div class="alternative-desc">' + a.desc + '</div>' +
        '</div></div>';
    }).join('');
  } else {
    altSection.style.display = 'none';
  }
  
  document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
  
  if (currentProduct) {
    currentProduct.score = healthResult.score;
  }
}

// ===== SCANNER FUNCTIONS =====
function startScanner() {
  document.getElementById('scannerModal').classList.add('active');
  document.getElementById('productInfo').classList.remove('active');
  document.getElementById('scannerContainer').style.display = 'block';
  showManualEntry();
}

function showManualEntry() {
  document.getElementById('scannerVideo').style.display = 'none';
  document.querySelector('.scanner-overlay').style.display = 'none';
  document.querySelector('.scanner-hint').style.display = 'none';
  document.getElementById('scannerStatus').innerHTML = 
    '<div class="search-ui">' +
    '<div class="search-ui-icon">üîç</div>' +
    '<div class="search-ui-title">Search by Product Name</div>' +
    '<input type="text" id="productSearch" class="search-input" placeholder="e.g. Doritos, Diet Coke, Oreos" onkeypress="if(event.key===\'Enter\')searchProduct()">' +
    '<button class="search-btn" onclick="searchProduct()">üîç Search</button>' +
    '<div class="search-divider">or enter barcode number</div>' +
    '<div class="barcode-row">' +
    '<input type="text" id="manualBarcode" class="barcode-input" inputmode="numeric" placeholder="049000006346" onkeypress="if(event.key===\'Enter\')handleBarcode(this.value)">' +
    '<button class="barcode-btn" onclick="handleBarcode(document.getElementById(\'manualBarcode\').value)">Go</button>' +
    '</div>' +
    '<button class="camera-btn" onclick="tryCamera()">üì∑ Try Camera Scan</button>' +
    '</div>';
}

function searchProduct() {
  var query = document.getElementById('productSearch').value.trim();
  if (!query) return;
  
  document.getElementById('scannerStatus').innerHTML = 
    '<div class="search-ui">' +
    '<div class="search-ui-icon" style="animation:spin 1s linear infinite">üîç</div>' +
    '<div class="search-ui-title">Searching...</div>' +
    '</div>' +
    '<style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
  
  fetch('https://world.openfoodfacts.org/cgi/search.pl?search_terms=' + encodeURIComponent(query) + '&search_simple=1&action=process&json=1&page_size=20&countries_tags_en=united-states&sort_by=unique_scans_n')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.products && data.products.length > 0) {
        showSearchResults(data.products, query);
      } else {
        document.getElementById('scannerStatus').innerHTML = 
          '<div class="search-ui">' +
          '<div class="search-ui-icon">üòï</div>' +
          '<div class="search-ui-title">No results for "' + query + '"</div>' +
          '<button class="search-btn" style="margin-top:20px" onclick="showManualEntry()">‚Üê Try Again</button>' +
          '</div>';
      }
    })
    .catch(function() {
      document.getElementById('scannerStatus').innerHTML = 
        '<div class="search-ui">' +
        '<div class="search-ui-icon">‚ùå</div>' +
        '<div class="search-ui-title">Search failed</div>' +
        '<button class="search-btn" style="margin-top:20px" onclick="showManualEntry()">‚Üê Try Again</button>' +
        '</div>';
    });
}

function showSearchResults(products, query) {
  var html = '<div class="search-results">' +
    '<div style="text-align:center;margin-bottom:16px;color:var(--text-secondary)">' + products.length + ' results for "' + query + '"</div>';
  
  products.forEach(function(p) {
    var name = p.product_name || 'Unknown';
    var brand = p.brands || '';
    var image = p.image_front_thumb_url || '';
    var hasIng = p.ingredients_text ? true : false;
    
    html += '<div class="search-result-card" onclick="selectProduct(\'' + (p.code || '') + '\')">' +
      (image ? '<img class="search-result-image" src="' + image + '">' : '<div class="search-result-placeholder">üì¶</div>') +
      '<div class="search-result-info">' +
      '<div class="search-result-name">' + name + '</div>' +
      '<div class="search-result-brand">' + brand + '</div>' +
      '</div>' +
      '<div class="search-result-badge ' + (hasIng ? 'has-ing' : 'no-ing') + '">' + (hasIng ? '‚úì' : '‚úó') + '</div>' +
      '</div>';
  });
  
  html += '<button class="back-btn" onclick="showManualEntry()">‚Üê Back to Search</button></div>';
  document.getElementById('scannerStatus').innerHTML = html;
}

function selectProduct(code) {
  if (code) handleBarcode(code);
}

function tryCamera() {
  document.getElementById('scannerStatus').innerHTML = '<div class="search-ui"><div class="search-ui-title">Starting camera...</div></div>';
  
  var readerDiv = document.getElementById('barcode-reader');
  if (!readerDiv) {
    readerDiv = document.createElement('div');
    readerDiv.id = 'barcode-reader';
    readerDiv.style.cssText = 'width:100%;max-width:500px;margin:0 auto;';
    document.getElementById('scannerContainer').appendChild(readerDiv);
  }
  readerDiv.innerHTML = '';
  readerDiv.style.display = 'block';
  
  if (quaggaRunning) {
    Quagga.stop();
    quaggaRunning = false;
  }
  
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: readerDiv,
      constraints: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
    },
    decoder: { readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader", "code_128_reader"] },
    locate: true,
    frequency: 10
  }, function(err) {
    if (err) {
      showManualEntry();
      return;
    }
    quaggaRunning = true;
    Quagga.start();
    document.getElementById('scannerStatus').innerHTML = 
      '<div style="position:absolute;bottom:20px;left:0;right:0;text-align:center;color:white;font-size:16px">Point at barcode</div>' +
      '<button onclick="showManualEntry()" style="position:absolute;top:20px;left:20px;padding:10px 16px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:8px">‚Üê Back</button>';
  });
  
  Quagga.onDetected(function(result) {
    if (result && result.codeResult && result.codeResult.code) {
      Quagga.stop();
      quaggaRunning = false;
      handleBarcode(result.codeResult.code);
    }
  });
}

function handleBarcode(code) {
  if (!code || code.length < 8) {
    alert('Enter valid barcode (8+ digits)');
    return;
  }
  
  document.getElementById('scannerStatus').innerHTML = 
    '<div class="search-ui">' +
    '<div class="search-ui-icon" style="animation:spin 1s linear infinite">üì¶</div>' +
    '<div class="search-ui-title">Looking up product...</div>' +
    '</div>' +
    '<style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
  
  fetch('https://world.openfoodfacts.org/api/v0/product/' + code + '.json')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.status === 1 && data.product) {
        var p = data.product;
        var name = p.product_name || 'Unknown';
        var brand = p.brands || '';
        var image = p.image_front_url || '';
        var ingredients = p.ingredients_text || '';
        var serving = p.serving_size ? 'Serving: ' + p.serving_size : '';
        
        scannedProductData = { code: code, name: name, brand: brand, image: image, ingredients: ingredients, serving: serving };
        scannedIngredients = ingredients;
        
        document.getElementById('productImage').src = image;
        document.getElementById('productImage').style.display = image ? 'block' : 'none';
        document.getElementById('productName').textContent = name;
        document.getElementById('productBrand').textContent = brand;
        document.getElementById('productServing').textContent = serving;
        
        document.getElementById('scannerContainer').style.display = 'none';
        document.getElementById('productInfo').classList.add('active');
        
        if (!ingredients) {
          document.getElementById('productInfo').innerHTML += '<div style="color:#fca5a5;text-align:center;padding:12px">‚ö†Ô∏è No ingredients found</div>';
        }
      } else {
        document.getElementById('scannerStatus').innerHTML = 
          '<div class="search-ui">' +
          '<div class="search-ui-icon">üòï</div>' +
          '<div class="search-ui-title">Product not found</div>' +
          '<button class="search-btn" onclick="showManualEntry()">‚Üê Try Again</button>' +
          '</div>';
      }
    })
    .catch(function() {
      document.getElementById('scannerStatus').innerHTML = 
        '<div class="search-ui">' +
        '<div class="search-ui-icon">‚ùå</div>' +
        '<div class="search-ui-title">Lookup failed</div>' +
        '<button class="search-btn" onclick="showManualEntry()">‚Üê Try Again</button>' +
        '</div>';
    });
}

function useScannedIngredients() {
  if (scannedIngredients) {
    document.getElementById('input').value = scannedIngredients;
    currentProduct = scannedProductData;
    showSelectedProduct(scannedProductData.name, scannedProductData.brand, scannedProductData.image, scannedProductData.serving);
  }
  stopScanner();
  analyze();
}

function scanAgain() {
  document.getElementById('productInfo').classList.remove('active');
  document.getElementById('scannerContainer').style.display = 'block';
  showManualEntry();
}

function stopScanner() {
  if (quaggaRunning) {
    try { Quagga.stop(); quaggaRunning = false; } catch(e) {}
  }
  var readerDiv = document.getElementById('barcode-reader');
  if (readerDiv) readerDiv.style.display = 'none';
  document.getElementById('scannerModal').classList.remove('active');
  document.getElementById('productInfo').classList.remove('active');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  renderFavorites();
});
</script>
</body>
</html>
